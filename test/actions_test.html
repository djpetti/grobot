<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>actions-test</title>

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../bower_components/polymer-redux/polymer-redux.js"></script>
    <script src="../bower_components/redux/index.js"></script>
    <script src="../bower_components/redux-saga/index.js"></script>
    <script src="../src/js/actions.js"></script>
    <script src="../src/js/main.js"></script>

    <link rel="import" href="../src/gb-action-panel.html">
  </head>
  <body>
    <test-fixture id="gbActionFixture">
      <template>
        <!-- This will be replaced with our fake action panel for testing. -->
        <gb-action-panel></gb-action-panel>
      </template>
    </test-fixture>

    <script>
      suite('actions.js', function() {
        var FakeActionPanelItem = null;
        var dispatchSaveAction = null;

				setup(function() {
          // A fake class for action panel items.
          FakeActionPanelItem = class {
            constructor(title, description, level) {
              this.title_ = title;
              this.description_ = description;
              this.level_ = level;
            }

            getTitle() {
              return this.title_;
            }

            getDescription() {
              return this.description_;
            }

            getLevel() {
              return this.level_;
            }
          }

          /**
           * @private
           * A helper function to automatically dispatch a corresponding
           * UPDATE_PANEL_ITEM_LIST action for a particular ADD_ITEM action.
           * Effectively allows us to model how the Saga behaves without
           * running it.
           * @param addAction The action we used to add the item.
           * @param currentState The current state to send to the reducer.
           * @returns The new state, after the item is saved.
           */
          dispatchSaveAction_ = function(addAction, currentState) {
            // Create a fake item to add.
            const node = new FakeActionPanelItem(addAction.title,
                                                 addAction.description,
                                                 addAction.level,
                                                 addAction.id);

            // Save it with Redux.
            let saveItemAction = actions.updatePanelItemList(addAction.id,
                                                             node);
            return actions.grobotAppReducer(currentState, saveItemAction)
          }

				  // Implements a fake action panel that allows us to add stuff.
				  stub('gb-action-panel', {
            /** Adds an item to the fake action panel.
             * @param title The title of the item.
             * @param description The description of the item.
             * @param level The level of the item.
             * @param id A unique ID for the item.
             * @returns The item that it added, which in this case is just an
             * object instead of a DOM node. */
				    addItem: function(title, description, level, id) {
				      return new FakeActionPanelItem(title, description, level);
				    },

				    /** Removes an item from the fake action panel.
				     * @param id The id of the item to remove. */
				    removeItem: function(id) {},
				  });

          // Use the stub instead of the actual one.
				  replace('gb-action-panel').with('fake-gb-action-panel');
				});

        test('an unknown action does not result in a state change',
             function(done) {
          // Empty action.
          const state = actions.initialState;
          let newState = actions.grobotAppReducer(state, 'BAD_ACTION');
          // The state shouldn't have changed.
          assert.deepEqual(state, newState);

          done();
        });

        test('the UPDATE_BACKEND_STATE action works',
             function(done) {
					// Create an initial state to start with.
					const state = actions.initialState;
					assert.isTrue(state.fromBackend.mcu_alive);

					// Now, create an action that should not change the state.
					const aliveAction = actions.updateBackendState(['mcu_alive'], true);

					// The state should remain the same.
					let newState = actions.grobotAppReducer(state, aliveAction);
					assert.deepEqual(state, newState);

					// Now, create an action that changes the state.
					const deadAction = actions.updateBackendState(['mcu_alive'], false);

					// The state should change.
					newState = actions.grobotAppReducer(state, deadAction);
					assert.notDeepEqual(state, newState);
					assert.isFalse(newState.fromBackend.mcu_alive);

					// Change it back.
					newState = actions.grobotAppReducer(newState, aliveAction);
					assert.deepEqual(state, newState);

          done();
        });

        test('the UPDATE_BACKEND_STATE action can update the full state',
             function(done) {
          // Create an initial state to start with.
          const state = actions.initialState;
          assert.isTrue(state.fromBackend.mcu_alive);

          // Create an action that completely replaces the state.
          const newParamAction =
              actions.updateBackendState([], {'new_param': 1});

          // The state should be updated accordingly.
          const newState = actions.grobotAppReducer(state, newParamAction);
          assert.deepEqual({'new_param': 1}, newState.fromBackend);

          done();
        });

        test('the UPDATE_BACKEND_STATE action can add a new parameter',
             function(done) {
          // Create an initial state to start with.
          const state = actions.initialState;
          assert.isTrue(state.fromBackend.mcu_alive);

          // Create an action that adds a new parameter.
          const newParamAction = actions.updateBackendState(['new_group',
                                                             'new_param'], 1);

          // The state should be updated accordingly.
          const newState = actions.grobotAppReducer(state, newParamAction);
          assert.equal(1, newState.fromBackend.new_group.new_param);
          assert.isTrue(state.fromBackend.mcu_alive);

          done();
        });

        test('the SET_ACTION_PANEL and ADD_PANEL_ITEM actions work',
             function(done) {
          // Get the testing panel.
          let panel = fixture('gbActionFixture');

          // Register as the action panel.
          const registerAction = actions.setActionPanel(panel);
          let state = actions.initialState;
          state = actions.grobotAppReducer(state, registerAction);

          // Make sure it got registered.
          assert.deepEqual(panel, state.actionPanel.actionPanel);

          // Try adding an item.
          let addItemAction = actions.addPanelItem('Test', 'Test item',
                                                   'normal', 't1');
          state = actions.grobotAppReducer(state, addItemAction);

          // The summary status level should be normal.
          assert.equal('normal', state.actionPanel.summaryLevel);

          // Make sure it got added in the right place.
          assert.equal(1, state.actionPanel.numNormal);

          // Dispatch the save action, and check that the node actually
          // gets saved.
          state = dispatchSaveAction_(addItemAction, state);
          let gotItem = state.actionPanel.items['t1'];
          assert.equal('Test', gotItem.getTitle());
          assert.equal('Test item', gotItem.getDescription());
          assert.equal('normal', gotItem.getLevel());

          // Try adding with warning level.
          addItemAction = actions.addPanelItem('Test', 'Test item',
                                               'warning', 't2');
          state = actions.grobotAppReducer(state, addItemAction);

          // The summary status level should be warning.
          assert.equal('warning', state.actionPanel.summaryLevel);

          // Dispatch another save action, and make sure it gets saved.
          state = dispatchSaveAction_(addItemAction, state);
          assert.equal(1, state.actionPanel.numWarning);
          gotItem = state.actionPanel.items['t2'];
          assert.equal('Test', gotItem.getTitle());
          assert.equal('Test item', gotItem.getDescription());
          assert.equal('warning', gotItem.getLevel());

          // Try adding with error level.
          addItemAction = actions.addPanelItem('Test', 'Test item',
                                               'error', 't3');
          state = actions.grobotAppReducer(state, addItemAction);

          // The summary status level should be error.
          assert.equal('error', state.actionPanel.summaryLevel);

          // Dispatch another save action, and make sure it gets saved.
          state = dispatchSaveAction_(addItemAction, state);
          assert.equal(1, state.actionPanel.numError);
          gotItem = state.actionPanel.items['t3'];
          assert.equal('Test', gotItem.getTitle());
          assert.equal('Test item', gotItem.getDescription());
          assert.equal('error', gotItem.getLevel());

          done();
        });

        test('the REMOVE_PANEL_ITEM action works', function(done) {
          // Get the testing panel.
          let panel = fixture('gbActionFixture');

          // Register as the action panel.
          const registerAction = actions.setActionPanel(panel);
          const state = actions.initialState;
          let newState = actions.grobotAppReducer(state, registerAction);

          // Try adding an item.
          let addItemAction = actions.addPanelItem('Test', 'Test item',
                                                   'normal', 't1');
          newState = actions.grobotAppReducer(newState, addItemAction);
          // Make sure it got added.
          assert.equal(1, newState.actionPanel.numNormal);
          // Issue a save action for it.
          newState = dispatchSaveAction_(addItemAction, newState);

          // Try removing the item.
          let remove_item_action = actions.removePanelItem('t1');
          newState = actions.grobotAppReducer(newState, remove_item_action);
          // Make sure it got removed.
          assert.equal(0, newState.actionPanel.numNormal);

          // Repeat with other item levels.
          addItemAction = actions.addPanelItem('Test', 'Test item',
                                               'warning', 't1');
          newState = actions.grobotAppReducer(newState, addItemAction);
          assert.equal(1, newState.actionPanel.numWarning);
          newState = dispatchSaveAction_(addItemAction, newState);

          remove_item_action = actions.removePanelItem('t1');
          newState = actions.grobotAppReducer(newState, remove_item_action);
          assert.equal(0, newState.actionPanel.numWarning);

          addItemAction = actions.addPanelItem('Test', 'Test item',
                                               'error', 't1');
          newState = actions.grobotAppReducer(newState, addItemAction);
          assert.equal(1, newState.actionPanel.numError);
          newState = dispatchSaveAction_(addItemAction, newState);

          remove_item_action = actions.removePanelItem('t1');
          newState = actions.grobotAppReducer(newState, remove_item_action);
          assert.equal(0, newState.actionPanel.numError);

          done();
        });
      });
    </script>
  </body>
</html>
